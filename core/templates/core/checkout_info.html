{% extends 'core/base.html' %}
{% load static price_filters %}

{% block title %}Thông tin | TechOne{% endblock %}

{% block content %}
<section class="checkout-steps">
    <div class="checkout-step active">
        <span class="step-index">1</span>
        <span class="step-label">THÔNG TIN</span>
    </div>
    <div class="checkout-step">
        <span class="step-index">2</span>
        <span class="step-label">THANH TOÁN</span>
    </div>
</section>

<section class="grid checkout-grid">
    <form class="card" method="post">
        {% csrf_token %}
        <div class="section-head">
            <h2>Thông tin đơn hàng</h2>
            <p class="helper">Kiểm tra sản phẩm và điền thông tin nhận hàng.</p>
        </div>

        {% if errors %}
        <div class="alert alert-danger">Vui lòng kiểm tra lại các thông tin bắt buộc.</div>
        {% endif %}

        {% if cart.get_total_quantity %}
        <ul class="list">
            {% for item in cart %}
            <li class="list-item">
                <div class="list-meta">
                    <strong>{{ item.product.name }}</strong>
                    <span>{{ item.quantity }} x {{ item.product.price|format_vnd }}</span>
                </div>
                <div class="price">{{ item.total_price|format_vnd }}</div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="empty-state">Giỏ hàng đang trống. Vui lòng thêm sản phẩm trước khi thanh toán.</div>
        {% endif %}

        <div class="section-head">
            <h3>Thông tin khách hàng</h3>
            <p class="helper">Dùng thông tin này để liên hệ và gửi hoá đơn.</p>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="customer-name">Họ và tên</label>
                <input id="customer-name" name="full_name" type="text" value="{{ form.full_name|default_if_none:'' }}" placeholder="Nguyễn Văn A">
                {% if errors.full_name %}<div class="form-error">{{ errors.full_name }}</div>{% endif %}
            </div>
            <div class="form-group">
                <label for="customer-phone">Số điện thoại</label>
                <input id="customer-phone" name="phone" type="tel" value="{{ form.phone|default_if_none:'' }}" placeholder="0123 456 789">
                {% if errors.phone %}<div class="form-error">{{ errors.phone }}</div>{% endif %}
            </div>
            <div class="form-group">
                <label for="customer-email">Email</label>
                <input id="customer-email" name="email" type="email" value="{{ form.email|default_if_none:'' }}" placeholder="email@example.com">
            </div>
        </div>

        <div class="section-head">
            <h3>Thông tin nhận hàng</h3>
            <p class="helper">Chọn hình thức nhận hàng phù hợp.</p>
        </div>
        <div class="radio-group">
            <label class="radio-card">
                <input type="radio" name="delivery" value="delivery" {% if form.delivery_method != 'pickup' %}checked{% endif %}>
                <span>Giao hàng tận nơi</span>
            </label>
            <label class="radio-card">
                <input type="radio" name="delivery" value="pickup" {% if form.delivery_method == 'pickup' %}checked{% endif %}>
                <span>Nhận tại cửa hàng</span>
            </label>
        </div>

        <input id="city_name" type="hidden" name="city_name" value="{{ form.city_name|default:'' }}">
        <input id="ward_name" type="hidden" name="ward_name" value="{{ form.ward_name|default:'' }}">
        <div class="form-grid">
            <div class="form-group">
                <label for="city">Tỉnh / Thành phố</label>
                <select id="city" name="city" class="js-custom-select" data-selected="{{ form.city|default:'' }}">
                    <option value="" selected>Đang tải danh sách...</option>
                </select>
                {% if errors.city %}<div class="form-error">{{ errors.city }}</div>{% endif %}
            </div>
            <div class="form-group">
                <label for="ward">Phường / Xã</label>
                <select id="ward" name="ward" class="js-custom-select" data-selected="{{ form.ward|default:'' }}" disabled>
                    <option value="" selected>Chọn Tỉnh/Thành trước</option>
                </select>
                {% if errors.ward %}<div class="form-error">{{ errors.ward }}</div>{% endif %}
            </div>
            <div class="form-group">
                <label for="address">Địa chỉ nhận hàng</label>
                <input id="address" name="address" type="text" value="{{ form.address|default:'' }}" placeholder="Số nhà, tên đường, tòa nhà...">
                {% if errors.address %}<div class="form-error">{{ errors.address }}</div>{% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="delivery-time">Thời gian giao hàng</label>
            <select id="delivery-time" name="delivery_time" class="js-custom-select">
                {% with fast_date=today|date:"d/m/Y" %}
                {% with fast_label="Giao siêu tốc: trước 14 giờ 30 phút ngày "|add:fast_date %}
                <option value="{{ fast_label }}" {% if form.delivery_time == fast_label %}selected{% endif %}>{{ fast_label }}</option>
                {% endwith %}
                {% endwith %}
                <option value="Giao trong ngày" {% if form.delivery_time == "Giao trong ngày" %}selected{% endif %}>Giao trong ngày</option>
                <option value="Giao tiết kiệm (2-3 ngày)" {% if form.delivery_time == "Giao tiết kiệm (2-3 ngày)" %}selected{% endif %}>Giao tiết kiệm (2-3 ngày)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="note">Ghi chú khác (nếu có)</label>
            <textarea id="note" name="note" placeholder="Ví dụ: giao giờ hành chính">{{ form.note|default:'' }}</textarea>
        </div>

        <div class="form-group">
            <label>Quý khách có muốn xuất hoá đơn công ty không?</label>
            <div class="radio-group">
                <label class="radio-card">
                    <input type="radio" name="invoice" value="yes" {% if form.invoice_required %}checked{% endif %}>
                    <span>Có</span>
                </label>
                <label class="radio-card">
                    <input type="radio" name="invoice" value="no" {% if not form.invoice_required %}checked{% endif %}>
                    <span>Không</span>
                </label>
            </div>
        </div>

        <div class="checkout-actions">
            <div class="summary-total">
                <span>Tổng tiền tạm tính</span>
                <strong>{{ total|format_vnd }}</strong>
            </div>
            <button class="btn-primary" type="submit">Tiếp tục</button>
            <a class="btn-ghost" href="{% url 'cart' %}">Quay lại giỏ hàng</a>
        </div>
    </form>

    <aside class="card">
        <div class="section-head">
            <h3>Tóm tắt thanh toán</h3>
            <p class="helper">Kiểm tra lại trước khi chuyển bước.</p>
        </div>
        <div class="summary-card">
            <div class="summary-line">
                <span>Số lượng sản phẩm</span>
                <strong>{{ cart.get_total_quantity }}</strong>
            </div>
            <div class="summary-line">
                <span>Tạm tính</span>
                <strong>{{ subtotal|format_vnd }}</strong>
            </div>
            <div class="summary-line">
                <span>Phí vận chuyển</span>
                <strong>{% if shipping %}{{ shipping|format_vnd }}{% else %}Miễn phí{% endif %}</strong>
            </div>
            <div class="summary-line">
                <span>Giảm giá trực tiếp</span>
                <strong>-{{ discount|format_vnd }}</strong>
            </div>
        </div>
    </aside>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'core/js/checkout-address.js' %}"></script>
{% endblock %}
